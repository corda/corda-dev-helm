{{- if .Values.kafka.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-kafka-connection-test"
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  containers:
    - name: {{ .Release.Name }}-kafka-connection-test
      image: {{ include "kafka.image" .Subcharts.kafka }}
      imagePullPolicy: {{ .Values.kafka.image.pullPolicy | quote }}
      {{- if .Values.kafka.containerSecurityContext.enabled }}
      securityContext:
        runAsUser: {{ .Values.kafka.containerSecurityContext.runAsUser }}
      {{- end }}
      {{- if eq .Values.kafka.auth.clientProtocol "tls" }}
      volumeMounts:
        - mountPath: "/certs"
          name: certs
          readOnly: true
      {{- end }}
      command:
        - kafka-topics.sh
        - --list
        - --bootstrap-server
        - {{ include "common.names.fullname" .Subcharts.kafka }}:{{ .Values.kafka.service.ports.client }}
        {{- if eq .Values.kafka.auth.clientProtocol "tls" }}
        - --command-config
        - /tmp/config.properties
        {{- end }}
      {{- if eq .Values.kafka.auth.clientProtocol "tls" }}
      lifecycle:
        postStart:
          exec:
            command: ["/bin/sh", "-c", "echo \"security.protocol=SSL\nssl.truststore.type=PEM\nssl.truststore.location=/certs/ca.crt\" > /tmp/config.properties"]
      {{- end }}
  {{- if eq .Values.kafka.auth.clientProtocol "tls" }}
  volumes:
    - name: certs
      secret:
        secretName: {{ printf "%s-0-tls" (include "common.names.fullname" .Subcharts.kafka) }}
        items:
          - key: ca.crt
            path: ca.crt
  {{- end }}
  restartPolicy: Never
{{- end }}
