{{- if .Values.kafka.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ .Release.Name }}-kafka-connection-test"
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  {{- include "kafka.imagePullSecrets" .Subcharts.kafka | nindent 2 }}
  containers:
    - name: {{ .Release.Name }}-kafka-connection-test
      image: {{ include "kafka.image" .Subcharts.kafka }}
      imagePullPolicy: {{ .Values.kafka.image.pullPolicy | quote }}
      {{- if .Values.kafka.containerSecurityContext.enabled }}
      securityContext:
        runAsUser: {{ .Values.kafka.containerSecurityContext.runAsUser }}
      {{- end }}
      {{- if or (eq .Values.kafka.auth.clientProtocol "sasl_tls") (eq .Values.kafka.auth.clientProtocol "tls")  }}
      volumeMounts:
        - mountPath: "/certs"
          name: certs
          readOnly: true
      {{- end }}
      command:
        - bash
        - -c
      args:
        - |
            touch /tmp/config.properties
            {{- if eq .Values.kafka.auth.clientProtocol "sasl_tls" }}
            echo "security.protocol=SASL_SSL" >> /tmp/config.properties
            {{- end }}
            {{- if eq .Values.kafka.auth.clientProtocol "tls" }}
            echo "security.protocol=SSL" >> /tmp/config.properties
            {{- end }}
            {{- if eq .Values.kafka.auth.clientProtocol "sasl" }}
            echo "security.protocol=SASL_PLAINTEXT" >> /tmp/config.properties
            {{- end }}
            {{- if or (eq .Values.kafka.auth.clientProtocol "sasl_tls") (eq .Values.kafka.auth.clientProtocol "tls")  }}
            echo "ssl.truststore.location=/certs/ca.crt" >> /tmp/config.properties
            echo "ssl.truststore.type={{ .Values.kafka.auth.tls.type | upper }}" >> /tmp/config.properties
            {{- if .Values.kafka.auth.tls.password }}
            echo "ssl.truststore.password={{ .Values.kafka.auth.tls.password }}" >> /tmp/config.properties
            {{- end }}
            {{- end }}
            {{- if or (eq .Values.kafka.auth.clientProtocol "sasl_tls") (eq .Values.kafka.auth.clientProtocol "sasl")  }}
            {{- if .Values.kafka.auth.sasl.mechanisms | regexFind "scram-sha-256" }}
            echo "sasl.mechanism=SCRAM-SHA-256" >> /tmp/config.properties
            {{- else if .Values.kafka.auth.sasl.mechanisms | regexFind "scram-sha-512" }}
            echo "sasl.mechanism=SCRAM-SHA-512" >> /tmp/config.properties
            {{- else }}
            echo "sasl.mechanism=PLAIN" >> /tmp/config.properties
            {{- end }}
            echo "sasl.jaas.config=org.apache.kafka.common.security.scram.ScramLoginModule required username=\"{{ first .Values.kafka.auth.sasl.jaas.clientUsers }}\" password=\"${KAFKA_SASL_PASSWORDS%%,*}\";">> /tmp/config.properties
            {{- end }}
            cat /tmp/config.properties
            kafka-topics.sh --list --bootstrap-server {{ include "common.names.fullname" .Subcharts.kafka }}:{{ .Values.kafka.service.ports.client }} --command-config /tmp/config.properties
      {{- if or (eq .Values.kafka.auth.clientProtocol "sasl_tls") (eq .Values.kafka.auth.clientProtocol "sasl")  }}
      env:
        - name: KAFKA_SASL_PASSWORDS
          valueFrom:
            secretKeyRef:
              name: {{ printf "%s-jaas" (include "common.names.fullname" .Subcharts.kafka) }}
              key: "client-passwords"
      {{- end }}
  {{- if or (eq .Values.kafka.auth.clientProtocol "sasl_tls") (eq .Values.kafka.auth.clientProtocol "tls")  }}
  volumes:
    - name: certs
      secret:
        secretName: {{ printf "%s-0-tls" (include "common.names.fullname" .Subcharts.kafka) }}
        items:
          - key: ca.crt
            path: ca.crt
  {{- end }}
  restartPolicy: Never
{{- end }}
